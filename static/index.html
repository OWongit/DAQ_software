<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DAQ Control Panel</title>
    <!-- We'll use Tailwind CSS for easy styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        // Customizing Tailwind theme slightly
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'idle': '#6b7280', // Gray
                        'logging': '#22c55e', // Green
                    }
                }
            }
        }
    </script>
    <style>
        /* A little extra style for disabled buttons */
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex items-center justify-center min-h-screen">

    <div class="w-full max-w-md bg-white rounded-lg shadow-xl p-6 md:p-8">
        <h1 class="text-3xl font-bold text-center text-gray-800 mb-6">DAQ Control Panel</h1>

        <!-- Status Section -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Status</h2>
            <div class="flex items-center p-4 bg-gray-50 rounded-lg">
                <div id="status-indicator" class="w-4 h-4 rounded-full bg-idle mr-3 transition-colors"></div>
                <span id="status-message" class="text-lg text-gray-800 font-medium">Connecting...</span>
            </div>
        </div>

        <!-- File Section -->
        <div class="mb-6">
            <h2 class="text-lg font-semibold text-gray-700 mb-2">Current File</h2>
            <div class="p-4 bg-gray-50 rounded-lg">
                <span id="file-name" class="text-gray-600 italic break-all">No file logged yet</span>
            </div>
        </div>

        <!-- Controls Section -->
        <div class="grid grid-cols-2 gap-4 mb-4">
            <button id="start-button" class="w-full bg-green-600 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-green-700 transition-all">
                Start Logging
            </button>
            <button id="stop-button" class="w-full bg-red-600 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-red-700 transition-all">
                Stop Logging
            </button>
        </div>

        <!-- Download Button (acts as a link) -->
        <a id="download-button" href="#" class="w-full bg-blue-600 text-white font-bold py-3 px-4 rounded-lg shadow hover:bg-blue-700 transition-all text-center block">
            Download Last File
        </a>

    </div>

    <script>
        // --- Get references to all our HTML elements ---
        const statusIndicator = document.getElementById('status-indicator');
        const statusMessage = document.getElementById('status-message');
        const fileName = document.getElementById('file-name');
        const startButton = document.getElementById('start-button');
        const stopButton = document.getElementById('stop-button');
        const downloadButton = document.getElementById('download-button');

        // --- State Variable ---
        // We need to remember the last file *after* logging stops
        let lastLoggedFile = null;

        /**
         * The main function to update the GUI.
         * It fetches the /api/status endpoint and updates all elements.
         */
        async function updateStatus() {
            try {
                const response = await fetch('/api/status');
                if (!response.ok) {
                    statusMessage.textContent = 'Error: Cannot connect to server';
                    statusIndicator.classList.remove('bg-logging');
                    statusIndicator.classList.add('bg-red-500'); // Use red for error
                    return;
                }
                
                const data = await response.json();

                // 1. Update Status Message
                statusMessage.textContent = data.message;

                // 2. Update button and indicator state
                if (data.is_logging) {
                    // --- We are LOGGING ---
                    statusIndicator.classList.remove('bg-idle');
                    statusIndicator.classList.add('bg-logging');

                    startButton.disabled = true;
                    stopButton.disabled = false;
                    downloadButton.classList.add('opacity-50', 'cursor-not-allowed');

                    // If a file is being logged, show its name
                    if (data.current_file) {
                        fileName.textContent = data.current_file;
                        lastLoggedFile = data.current_file; // Keep track of this
                    }
                } else {
                    // --- We are IDLE ---
                    statusIndicator.classList.remove('bg-logging');
                    statusIndicator.classList.add('bg-idle');

                    startButton.disabled = false;
                    stopButton.disabled = true;

                    // Handle download link
                    if (lastLoggedFile) {
                        fileName.textContent = lastLoggedFile;
                        downloadButton.classList.remove('opacity-50', 'cursor-not-allowed');
                        // Set the 'href' to the correct download path
                        downloadButton.href = '/data/' + lastLoggedFile;
                    } else {
                        fileName.textContent = 'No file logged yet';
                        downloadButton.classList.add('opacity-50', 'cursor-not-allowed');
                    }
                }

            } catch (error) {
                console.error("Error fetching status:", error);
                statusMessage.textContent = 'Connection lost';
                statusIndicator.classList.remove('bg-logging');
                statusIndicator.classList.add('bg-red-500');
            }
        }

        /**
         * Event listener for the START button.
         */
        startButton.addEventListener('click', async () => {
            try {
                // Disable button to prevent double-click
                startButton.disabled = true;
                startButton.textContent = 'Starting...';

                const response = await fetch('/api/logging/start', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    console.log("Start successful:", data);
                    // We don't need to do anything else,
                    // the updateStatus() loop will see the change.
                } else {
                    alert('Error: ' + (data.error || 'Failed to start logging.'));
                }
            } catch (error) {
                console.error("Error starting log:", error);
                alert('Connection error. Could not start logging.');
            } finally {
                // Let updateStatus() handle re-enabling
                startButton.textContent = 'Start Logging';
                updateStatus(); // Poll immediately
            }
        });

        /**
         * Event listener for the STOP button.
         */
        stopButton.addEventListener('click', async () => {
            try {
                // Disable button to prevent double-click
                stopButton.disabled = true;
                stopButton.textContent = 'Stopping...';

                const response = await fetch('/api/logging/stop', { method: 'POST' });
                const data = await response.json();
                
                if (response.ok) {
                    console.log("Stop successful:", data);
                    // THIS IS KEY: Save the filename we got back
                    if (data.filename) {
                        lastLoggedFile = data.filename;
                    }
                } else {
                    alert('Error: ' + (data.error || 'Failed to stop logging.'));
                }
            } catch (error) {
                console.error("Error stopping log:", error);
                alert('Connection error. Could not stop logging.');
            } finally {
                // Let updateStatus() handle re-enabling
                stopButton.textContent = 'Stop Logging';
                updateStatus(); // Poll immediately
            }
        });


        // --- Run the update function on load and every 2 seconds ---
        document.addEventListener('DOMContentLoaded', () => {
            updateStatus(); // Run immediately on page load
            setInterval(updateStatus, 2000); // Poll every 2 seconds
        });

    </script>
</body>
</html>